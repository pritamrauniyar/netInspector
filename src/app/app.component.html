<div class="app-shell">
  <div class="title">
    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
      <rect width="24" height="24" rx="6" fill="#0ea5e9" opacity="0.12"></rect>
      <path d="M4 12h16M12 4v16" stroke="#60a5fa" stroke-width="1.5" stroke-linecap="round"></path>
    </svg>
    <h1>Device & Network</h1>
    <div style="flex:1"></div>
    <div class="muted">Orientation: {{ orientation }}</div>
  </div>

  <div class="grid" role="region" aria-label="Device and network information">
    <!-- Real test server UI removed; using client-side simulated tests -->
    <section class="card" aria-labelledby="device-heading">
      <h3 id="device-heading">Device Details</h3>
      <div class="muted">Detected information from user agent and viewport</div>

      <dl style="margin-top:12px;">
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)">
          <dt class="small">User Agent</dt>
          <dd class="small" style="max-width:60%">{{ deviceInfo.userAgent }}</dd>
        </div>

        <div style="display:flex;justify-content:space-between;padding:8px 0;">
          <dt>OS</dt>
          <dd>{{ deviceInfo.os }} {{ deviceInfo.osVersion ? ' ' + deviceInfo.osVersion : '' }}</dd>
        </div>

        <div style="display:flex;justify-content:space-between;padding:8px 0;">
          <dt>Browser</dt>
          <dd>{{ deviceInfo.browser }} {{ deviceInfo.browserVersion ? ' ' + deviceInfo.browserVersion : '' }}</dd>
        </div>

        <div style="display:flex;justify-content:space-between;padding:8px 0;">
          <dt>Device Type</dt>
          <dd>{{ deviceInfo.deviceType }}</dd>
        </div>

        <div style="display:flex;justify-content:space-between;padding:8px 0;">
          <dt>Device Model</dt>
          <dd>{{ deviceInfo.deviceModel || '-' }}</dd>
        </div>

        <div style="display:flex;justify-content:space-between;padding:8px 0;">
          <dt>Is Desktop</dt>
          <dd>{{ isDesktop() }}</dd>
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;">
          <dt>Timezone</dt>
          <dd>{{ timezone || '-' }}</dd>
        </div>
      </dl>
      <div style="height:10px"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button (click)="showFullDeviceInfo = !showFullDeviceInfo" class="small" aria-expanded="false" aria-controls="full-device-info">{{ showFullDeviceInfo ? 'Hide' : 'Show' }} full info</button>
        <button (click)="fetchFullDeviceInfo()" class="small">Refresh full info</button>
      </div>

      <div id="full-device-info" *ngIf="showFullDeviceInfo" style="margin-top:8px">
        <div class="muted small">Missing fields: {{ countMissingFullInfo() }}</div>
        <div style="height:8px"></div>
        <div class="full-info-grid">
          <div class="group" *ngFor="let g of getFullInfoGroups()">
            <div class="group-title"> <span class="icon" aria-hidden>{{ g.icon }}</span> {{ g.title }}</div>
            <div class="group-items">
              <div class="info-row" *ngFor="let it of g.items">
                <div class="info-key">{{ it.label }}</div>
                <div style="display:flex;align-items:center;gap:8px">
                  <div class="info-val" [class.missing]="it.v===null||it.v===undefined||it.v===''">{{ it.v ?? '—' }}</div>
                  <button *ngIf="it.v===null||it.v===undefined||it.v===''" class="why-btn small" (click)="toggleHelp(it.label)" aria-expanded="false">Why?</button>
                </div>
                <div *ngIf="helpOpen[it.label]" class="help-row">
                  <div class="help-text small">{{ getHelpMessage(it.label) }}</div>
                  <a *ngIf="getDeepLink(it.label) as dl" [href]="dl.url" target="_blank" rel="noopener" class="small link">{{ dl.label }}</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <aside class="card" aria-labelledby="speed-heading">
      <h3 id="speed-heading">Internet Speed</h3>
      <div class="muted">Live simulated measurement</div>

      <div class="speed-meter" style="margin-top:14px">
        <div>
          <div class="small">Download</div>
          <div class="speed-value" [class.pulse]="downloadPulse" aria-live="polite">{{ downloadSpeed ?? '—' }} <span class="small" style="font-weight:600">Mbps</span></div>
          <svg width="100%" height="40" viewBox="0 0 120 40" preserveAspectRatio="none" style="margin-top:6px">
            <polyline fill="none" stroke="#60a5fa" stroke-width="1.6" [attr.points]="renderSparkline(downloadHistory, 120, 40)" />
          </svg>
        </div>

        <div>
          <div class="small">Upload</div>
          <div class="speed-value" [class.pulse]="uploadPulse" style="color:#7c3aed" aria-live="polite">{{ uploadSpeed ?? '—' }} <span class="small" style="font-weight:600">Mbps</span></div>
          <svg width="100%" height="40" viewBox="0 0 120 40" preserveAspectRatio="none" style="margin-top:6px">
            <polyline fill="none" stroke="#c084fc" stroke-width="1.6" [attr.points]="renderSparkline(uploadHistory, 120, 40)" />
          </svg>
        </div>

  <div class="muted" style="margin-top:6px">Network status: <strong>{{ (isOnline$ | async) ? 'Online' : 'Offline' }}</strong></div>
      </div>
    </aside>

    <section class="card">
      <h3>Network & System</h3>
      <div class="muted">Connection and device system info</div>
      <div style="margin-top:12px">
        <div class="row" [class.value-updated]="connection">
          <div style="display:flex;align-items:center;gap:10px"><span class="icon" aria-hidden>
            <svg viewBox="0 0 24 24" fill="none"><path d="M2 12c5-6 13-6 20 0" stroke="#60a5fa" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span><div class="small">Connection</div></div>
          <div class="small">{{ connection?.type || 'unknown' }} ({{ connection?.effectiveType || '-' }})</div>
        </div>

        <div class="row"><div class="small">Downlink</div><div class="small">{{ connection?.downlink ?? '-' }} Mbps</div></div>

        <div class="row"><div class="small">RTT</div><div class="small">{{ connection?.rtt ?? '-' }} ms</div></div>

        <div style="height:8px"></div>
        <div class="row">
          <div style="display:flex;align-items:center;gap:10px">
            <span class="icon" aria-hidden>
              <svg viewBox="0 0 24 24" fill="none"><rect x="6" y="7" width="12" height="10" rx="2" stroke="#fbbf24" stroke-width="1.6"/><rect x="9" y="4" width="6" height="3" rx="1.5" stroke="#fbbf24" stroke-width="1.2"/></svg>
            </span>
            <div class="tooltip-parent">
              <button (click)="fetchBattery()" class="small" style="padding:6px 10px;border-radius:8px"
                aria-label="Get battery information" aria-describedby="battery-tooltip" title="Get battery level">Get Battery</button>
              <div id="battery-tooltip" role="tooltip" class="tooltip">Reads the device battery level and charging state (if supported).</div>
            </div>
          </div>
          <div class="small">Battery: <span [class.value-updated]="batteryUpdated" aria-live="polite">{{ battery?.level ?? '-' }}%</span> {{ battery?.charging ? '(charging)' : '' }}</div>
        </div>
        <div style="height:8px"></div>
        <div class="row">
          <div style="display:flex;align-items:center;gap:10px"><span class="icon" aria-hidden>
            <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="10" r="3" stroke="#34d399" stroke-width="1.6"/><path d="M21 21l-4.35-4.35" stroke="#34d399" stroke-width="1.6" stroke-linecap="round"/></svg>
            </span>
            <div class="tooltip-parent">
              <button (click)="fetchGeolocation()" class="small" style="padding:6px 10px;border-radius:8px"
                aria-label="Get device location" aria-describedby="geo-tooltip" title="Get current location">Get Location</button>
              <div id="geo-tooltip" role="tooltip" class="tooltip">Requests the device location (latitude / longitude) via the Geolocation API.</div>
            </div>
          </div>
          <div class="small">Location: <span [class.value-updated]="geolocationUpdated" aria-live="polite">{{ geolocation?.latitude ? (geolocation.latitude | number:'1.4-4') : '-' }}, {{ geolocation?.longitude ? (geolocation.longitude | number:'1.4-4') : '-' }}</span></div>
        </div>
      </div>
    </section>
    
    <aside class="card" aria-labelledby="diag-heading">
      <h3 id="diag-heading">Diagnostics</h3>
      <div class="muted">Quick device & network diagnostics</div>
      <div style="margin-top:12px">
        <div class="row">
          <div class="small">Performance Score</div>
          <div style="flex:1;margin-left:10px">
            <div class="perf-gauge" role="progressbar" [attr.aria-valuemin]="0" [attr.aria-valuemax]="100" [attr.aria-valuenow]="perfScore">
              <div class="perf-fill" [style.width.%]="perfScore ?? 0" [style.background]="perfColor(perfScore)"></div>
            </div>
          </div>
          <div class="small" aria-live="polite">{{ perfScore ?? '—' }} / 100</div>
        </div>

        <div style="height:8px"></div>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <button (click)="generateDiagnostics()" class="small" aria-label="Generate diagnostics report">Generate</button>
          <button (click)="downloadReport('json')" class="small" aria-label="Download diagnostics as JSON">Download JSON</button>
          <button (click)="downloadReport('csv')" class="small" aria-label="Download speed history as CSV">Download CSV</button>
          <button (click)="copyReport()" class="small" aria-label="Copy diagnostics to clipboard">Copy</button>
        </div>

        <div style="height:8px"></div>
        <div *ngIf="lastReportJson" style="max-height:160px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;font-family:monospace;font-size:0.8rem">
          <pre style="white-space:pre-wrap">{{ lastReportJson }}</pre>
        </div>
      </div>
    </aside>

    <section class="card" aria-labelledby="trouble-heading">
      <h3 id="trouble-heading">Troubleshooter</h3>
      <div class="muted">Quick QoE estimator and actionable tips</div>
      <div style="margin-top:12px">
        <div class="row" style="align-items:flex-start;gap:16px">
          <div style="flex:1">
            <div class="small">Estimated Quality</div>
            <div style="display:flex;gap:12px;margin-top:6px">
              <div class="small">720p: <strong>{{ qoe?.video720 || '—' }}</strong></div>
              <div class="small">1080p: <strong>{{ qoe?.video1080 || '—' }}</strong></div>
              <div class="small">Voice: <strong>{{ qoe?.voice || '—' }}</strong></div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button (click)="runQuickChecks()" class="small" [disabled]="quickCheckRunning" aria-label="Run quick troubleshooting checks">Run Quick Check</button>
            <button (click)="generateDiagnostics()" class="small" aria-label="Generate diagnostics report for troubleshooting">Generate Report</button>
          </div>
        </div>

        <div style="height:10px"></div>
        <div *ngIf="recommendations?.length">
          <div class="small">Recommendations</div>
          <ol style="margin-top:6px">
            <li *ngFor="let r of recommendations" class="small">{{ r }}</li>
          </ol>
        </div>
      </div>
    </section>

    <aside class="card" aria-labelledby="webrtc-heading">
      <h3 id="webrtc-heading">WebRTC Loopback Test</h3>
      <div class="muted">Lightweight in-browser loopback to estimate RTT, jitter, and packet loss</div>
      <div style="margin-top:12px">
        <div style="display:flex;gap:10px;align-items:center">
          <button (click)="startWebRTCLoopback()" class="small" [disabled]="webrtcRunning">Start</button>
          <button (click)="stopWebRTCLoopback()" class="small" [disabled]="!webrtcRunning">Stop</button>
          <div class="small">Status: <strong>{{ webrtcRunning ? 'Running' : 'Stopped' }}</strong></div>
        </div>

        <div style="height:10px"></div>
        <div class="row">
          <div class="small">RTT (ms)</div>
          <div class="small">{{ webrtcStats.rttSamples.length ? (webrtcStats.rttSamples[webrtcStats.rttSamples.length-1]) : '-' }}</div>
        </div>
        <div class="row">
          <div class="small">Jitter (ms)</div>
          <div class="small">{{ webrtcStats.jitterSamples.length ? (webrtcStats.jitterSamples[webrtcStats.jitterSamples.length-1]) : '-' }}</div>
        </div>
        <div class="row">
          <div class="small">Loss (%)</div>
          <div class="small">{{ webrtcStats.lossSamples.length ? (webrtcStats.lossSamples[webrtcStats.lossSamples.length-1]) : '-' }}</div>
        </div>
      </div>
    </aside>
  </div>
</div>